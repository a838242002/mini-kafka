# v1.0.0 (Day1) - Minimal Kafka-Style Broker

這份文件整理 Day1 最簡單版本的 Kafka 原理實作，描述目前能做什麼、有哪些核心元件，以及協定與儲存格式。

## 目標與範圍

本版本提供最小可用的 broker：

- 支援 Produce 與 Fetch
- 依 topic/partition 存取 append-only log
- 使用簡化的自訂二進位協定
- 單一 broker、無複寫、無一致性協議

## 架構概覽

主要模組：

- `crates/net`：TCP 伺服器與 frame 讀寫（長度前綴）
- `crates/protocol`：Request/Response 定義與編解碼
- `crates/broker`：請求處理與 partition log 管理
- `crates/storage`：append-only log 檔案與 offset 索引

資料流：

1. TCP 連線進來後由 `net::serve` 接收
2. 讀取 frame（`u32` 長度 + payload）
3. `protocol::decode_request` 解析請求
4. `broker::handle` 分派 Produce 或 Fetch
5. `storage::PartitionLog` 寫入或讀取檔案
6. `protocol::encode_response` 封包回寫

## 協定簡述

### Frame 格式

```
u32 (big-endian length) + [payload bytes]
```

### Request API key

- `1`：Produce
- `2`：Fetch

### Produce Request

```
u8  api_key=1
str topic (u16 len + bytes)
u16 partition
u16 record_count
repeat record_count:
  u16 key_len + key bytes
  u32 value_len + value bytes
```

### Fetch Request

```
u8  api_key=2
str topic (u16 len + bytes)
u16 partition
i64 offset
u32 max_bytes
```

### Response

- Produce Response (`api_key=1`): `u8 status` + `i64 base_offset`
- Fetch Response (`api_key=2`): `u8 status` + `u16 item_count` + items
- Error Response (`api_key=255`): `str message`

Fetch items 格式：

```
i64 offset
u16 key_len + key bytes
u32 value_len + value bytes
```

## 儲存格式

每個 `(topic, partition)` 對應一個 `.log` 檔案，格式為：

```
[offset:i64][klen:u16][key bytes][vlen:u32][value bytes]
```

重點：

- 檔案為 append-only；寫入時依序追加
- 啟動時掃描整個檔案，建立 `offset -> file_pos` 的索引（`BTreeMap`）
- `fetch` 依索引 seek 到對應位置後逐筆讀取

### Durability

`append` 完成後會：

1. `flush()`：將使用者態 buffer 寫入 OS page cache
2. `sync_data()`：要求 OS 將資料寫入磁碟

## Broker 行為

- `Broker` 以 `Mutex<HashMap<(String, u16), PartitionLog>>` 管理 partition logs
- `get_or_open` 會從 map 取出 log（`remove`），用完後再 `put_back`
- 這樣避免長時間持鎖，但同一時間同一個 partition 只會被一個請求操作

## 併發模型

- 每個 TCP 連線由一個 `tokio::spawn` task 處理
- 協定解析與 IO 在 async runtime 內進行

## 限制與非目標

- 單一 broker，沒有 replication/ISR/leader election
- 無 consumer group、offset commit、rebalancing
- 無壓縮、無批次壓縮或 checksum
- 無 ACL、SASL、TLS
- 無 retention/compaction/segment rolling

## 啟動方式

```
cargo run -p broker-bin
```

預設會：

- 監聽 `127.0.0.1:9092`
- 使用 `data/` 作為 log 根目錄
